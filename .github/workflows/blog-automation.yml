name: ğŸ“ Blog Automation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # ë§¤ì¼ ìì •ì— ì‹¤í–‰ (KST ê¸°ì¤€ ì˜¤ì „ 9ì‹œ)
    - cron: "0 0 * * *"

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run type-check

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Build project
        run: npm run build

  seo-check:
    name: SEO and Performance Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Wait for deployment
        run: sleep 60

      - name: Check sitemap
        run: |
          curl -f https://mykim.in/sitemap.xml || exit 1
          echo "âœ… Sitemap is accessible"

      - name: Check robots.txt
        run: |
          curl -f https://mykim.in/robots.txt || exit 1
          echo "âœ… Robots.txt is accessible"

      - name: Check RSS feed
        run: |
          curl -f https://mykim.in/rss.xml || exit 1
          echo "âœ… RSS feed is accessible"

  create-weekly-report:
    name: Create Weekly Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Generate weekly report
        uses: actions/github-script@v7
        with:
          script: |
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            // ì§€ë‚œ ì£¼ ì´ìŠˆë“¤ ê°€ì ¸ì˜¤ê¸°
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              since: oneWeekAgo.toISOString(),
              state: 'all'
            });

            // ì§€ë‚œ ì£¼ PRë“¤ ê°€ì ¸ì˜¤ê¸°
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all'
            });

            const weeklyReport = `
            # ğŸ“Š Weekly Report (${oneWeekAgo.toISOString().split('T')[0]} ~ ${new Date().toISOString().split('T')[0]})

            ## ğŸ“ˆ Statistics
            - ìƒˆë¡œìš´ ì´ìŠˆ: ${issues.data.length}ê°œ
            - ìƒˆë¡œìš´ PR: ${prs.data.length}ê°œ
            - ì™„ë£Œëœ ì‘ì—…: ${issues.data.filter(i => i.state === 'closed').length}ê°œ

            ## ğŸ¯ ì£¼ìš” í™œë™
            ${issues.data.slice(0, 5).map(issue => `- [#${issue.number}](${issue.html_url}) ${issue.title}`).join('\n')}

            ## ğŸ“ ë‹¤ìŒ ì£¼ ê³„íš
            - [ ] ìƒˆë¡œìš´ ê¸°ëŠ¥ ê°œë°œ
            - [ ] ë²„ê·¸ ìˆ˜ì •
            - [ ] ì„±ëŠ¥ ìµœì í™”
            `;

            // ì´ìŠˆë¡œ ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„±
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š Weekly Report - ${new Date().toISOString().split('T')[0]}`,
              body: weeklyReport,
              labels: ['report', 'weekly']
            });

  auto-assign-reviewer:
    name: Auto assign reviewer
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - name: Auto assign reviewer
        uses: actions/github-script@v7
        with:
          script: |
            // PR ì‘ì„±ìê°€ ë³¸ì¸ì´ë©´ ìë™ìœ¼ë¡œ ë¦¬ë·°ì–´ í• ë‹¹í•˜ì§€ ì•ŠìŒ
            if (context.payload.pull_request.user.login === 'BradleyyKim') {
              console.log('PR author is the owner, skipping auto-assignment');
              return;
            }

            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              reviewers: ['BradleyyKim']
            });
